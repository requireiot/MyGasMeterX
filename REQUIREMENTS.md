# Requirements specification for MyGasMeter

Notation:
- [x] requirement is implemented and tested. 
- [ ] requirement is not implemented or tested, ideas for future versions.

## Objectives

- I want to know the cost of heating, i.e. natural gas consumption, throughout the year.
- I expect this to be a low-cost, low-hassle system, i.e. low cost of materials, and infrequent battery changes.
- I expect the system to work in "sunny day operation" as well as in edge cases, i.e. restarts of the sensor, restarts of the home automation system, or temporary failure of the gateway

## Architecture

The *system* consists of 
- a *sensor node*, 
- a MySensors-to-MQTT *gateway* (`mysgw` running on a Raspberry Pi), 
- an MQTT broker (Mosquitto) and 
- a *home automation controller* (openHAB 2.5).

## Scope

This document describes a mixture of
- *system requirements*, which need to be satisfied by the entire system, not a particular component, and
- *component requirements*, which must be satisfied by the sensor node itself

## Sensor requirements

### Connectivity

- [x] `R011` the sensor node interfaces with a gas meter that generates magnetic pulses proportional to the amount of gas consumed
- [x] `R012` the sensor node interfaces with the *MySensors* network of low-power RF nodes
- [x] `R013` the sensor node reports information via MQTT, for compatibility with multiple home automation controllers
- [x] `R014` the sensor node reports information in a way that can be interpreted by openHAB

### Normal operation

- [x] `R021` the sensor node counts the magnetic pulses generated by the gas meter
- [x] `R022` at regular intervals, the sensor node reports the number of pulses 
   - [x] `R022.01` the sensor node reports the number of pulses seen since the last report (*relative count*)
   - [x] `R022.02` the sensor node can report the total number of pulses since a reference point (*absolute* count)
- [x] `R023` the sensor node can report the total amount of gas volume consumed since the reference point
- [x] `R024` Once per hour, the sensor node reports to the MySensors gateway the gas flow rate in liters/hour
- [x] `R025` if a sensor contains an ambient brightness sensor, it reports ambient brightness, at regular intervals, in percent of a non-calibrated fullscale value
- [x] `R026` if a sensor contains a climate sensor, it reports temperature, at regular invervals, in degrees Celcius
- [x] `R027` if a sensor contains a climate sensor, it reports humidity, at regular invervals, in percent relative humidity

### Configuration

- [x] `R031` the interval for reporting counts is configurable in source code
- [ ] `R032` the interval for reporting counts is configurable at run time
- [x] `R033` the conversion factor from pulses to liters is configurable in source code
- [x] `R034` the interval for reporting ambient brightness is configurable in source code
- [x] `R035` the interval for reporting temperature is configurable in source code
- [x] `R036` the interval for reporting humidity is configurable in source code

### Installation and initialization

- [x] `R041` the sensor node displays the state of the magnetic sensor with an LED, to help with correct positioning of the reed switch

### Performance

- [x] `R051` The sensor node runs for at least 12 months without replacing batteries

### Variants
- [x] `R061` a sensor node may contain an ambient brightness sensor, this is configurable in source code
- [x] `R062` a sensor node may contain a climate sensor (temperature and humidity), this is configurable in source code

## System requirements

### Normal operation

- [x] `R101` the *system* reports energy consumption in m³ for set intervals
   - [x] `R101.01` the *system* reports energy consumption in m³ per day
   - [x] `R101.02` the *system* reports energy consumption in m³ per week
   - [x] `R101.03` the *system* reports energy consumption in m³ per month
- [x] `R102` the *system* reports energy cost for set intervals
   - [x] `R102.01` the *system* reports energy cost per day
   - [x] `R102.02` the *system* reports energy cost per week
   - [x] `R102.03` the *system* reports energy cost per month
- [x] `R103` the *system* can report historical data for energy consumption, at least for the past 12 months
- [x] `R104` the *system* can report historical data for energy cost, at least for the past 12 months

### Configuration

- [x] `R111` the conversion factor from energy consumption in m³ to energy cost in € is configurable in source code

### Installation and initialization

- [x] `R121` the reference point (initial number of pulses) can be configured at run-time, once, after the sensor node starts
- [x] `R122` restarting the sensor node, e.g. after replacing the batteries, must not affect the gas meter values reported by the system
- [x] `R123` restarting the home automation controller must not affect the gas meter values reported by the system

### Fault conditions
- [x] `R131` the long-term data displayed by the system are correct even if some RF messages from the sensor node don't reach the gateway
- [x] `R132` the long-term data displayed by the system are correct even if the gateway is down for some time (hours)

## Build environment requirements

- [x] `R203` firmware images for multiple nodes with different configurations can be built from a common set of source code
